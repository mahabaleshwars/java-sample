name: Test SDKMAN - Amazon Corretto

on:
  workflow_dispatch:

jobs:
  test-corretto-with-sdkmanrc:
    name: Corretto with .sdkmanrc - ${{ matrix.version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        version:
          - '25.0.1-amzn'
          - '25-amzn'
          - '24.0.2-amzn'
          - '23.0.2-amzn'
          - '21.0.9-amzn'
          - '21.0.8-amzn'
          - '17.0.17-amzn'
          - '17.0.16-amzn'
          - '11.0.29-amzn'
          - '11.0.28-amzn'
          - '8.0.472-amzn'
          - '8.0.462-amzn'
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .sdkmanrc file
        run: |
          echo "java=${{ matrix.version }}" > .sdkmanrc
          echo "Created .sdkmanrc with content:"
          cat .sdkmanrc
        shell: bash
      
      - name: Setup Java with SDKMAN using .sdkmanrc
        uses: guicamest/setup-java@feat/669/support_sdkmanrc
        with:
          distribution: 'corretto'
          java-version-file: '.sdkmanrc'
      
      - name: Verify Java installation
        run: |
          java -version
          javac -version
          echo "JAVA_HOME=$JAVA_HOME"
          echo "PATH=$PATH"
          
      - name: Test Java compilation and execution
        run: |
          cat > Test.java << 'EOF'
          public class Test {
              public static void main(String[] args) {
                  System.out.println("Java Version: " + System.getProperty("java.version"));
                  System.out.println("Java Vendor: " + System.getProperty("java.vendor"));
                  System.out.println("Java Home: " + System.getProperty("java.home"));
                  System.out.println("OS: " + System.getProperty("os.name"));
              }
          }
          EOF
          javac Test.java
          java Test

  test-corretto-with-cache:
    name: Corretto with ${{ matrix.cache }} cache - ${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        version: ['21.0.9-amzn', '17.0.17-amzn', '11.0.29-amzn']
        cache: [maven, gradle, sbt]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup build files for cache testing
        run: |
          # Create .sdkmanrc
          echo "java=${{ matrix.version }}" > .sdkmanrc
          
          # Create build files based on cache type
          if [ "${{ matrix.cache }}" = "maven" ]; then
            cat > pom.xml << 'EOF'
          <project xmlns="http://maven.apache.org/POM/4.0.0">
            <modelVersion>4.0.0</modelVersion>
            <groupId>com.test</groupId>
            <artifactId>test-app</artifactId>
            <version>1.0</version>
            <dependencies>
              <dependency>
                <groupId>junit</groupId>
                <artifactId>junit</artifactId>
                <version>4.13.2</version>
                <scope>test</scope>
              </dependency>
            </dependencies>
          </project>
          EOF
          elif [ "${{ matrix.cache }}" = "gradle" ]; then
            cat > build.gradle << 'EOF'
          plugins {
              id 'java'
          }
          repositories {
              mavenCentral()
          }
          dependencies {
              testImplementation 'junit:junit:4.13.2'
          }
          EOF
            echo 'rootProject.name = "test-app"' > settings.gradle
          elif [ "${{ matrix.cache }}" = "sbt" ]; then
            cat > build.sbt << 'EOF'
          name := "test-app"
          version := "1.0"
          scalaVersion := "2.13.12"
          libraryDependencies += "org.scalatest" %% "scalatest" % "3.2.17" % Test
          EOF
            mkdir -p project
            echo 'sbt.version=1.9.7' > project/build.properties
          fi
        shell: bash
        
      - name: Setup Java with SDKMAN and cache
        uses: actions/setup-java@sdkman-integration
        with:
          distribution: 'corretto'
          java-version-file: '.sdkmanrc'
          cache: ${{ matrix.cache }}
          
      - name: Verify cache and build
        run: |
          java -version
          echo "Cache type: ${{ matrix.cache }}"
          if [ "${{ matrix.cache }}" = "maven" ]; then
            mvn dependency:resolve
          elif [ "${{ matrix.cache }}" = "gradle" ]; then
            ./gradlew dependencies || gradlew dependencies
          elif [ "${{ matrix.cache }}" = "sbt" ]; then
            sbt update
          fi
        shell: bash
        continue-on-error: true

  test-corretto-multiple-versions:
    name: Corretto Multiple Versions Setup
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup multiple Corretto versions
        run: |
          # Test setting up multiple versions in sequence
          versions=("8.0.472-amzn" "11.0.29-amzn" "17.0.17-amzn" "21.0.9-amzn")
          
          for version in "${versions[@]}"; do
            echo "Setting up Java ${version}"
            echo "java=${version}" > .sdkmanrc-${version}
            
            # Create a test directory for each version
            mkdir -p test-${version}
            cd test-${version}
            cp ../.sdkmanrc-${version} .sdkmanrc
            cd ..
          done
        shell: bash
        
      - name: Setup Java 8
        uses: actions/setup-java@sdkman-integration
        with:
          distribution: 'corretto'
          java-version-file: 'test-8.0.472-amzn/.sdkmanrc'
          
      - name: Verify Java 8
        run: |
          java -version 2>&1 | grep "1.8" || echo "Java 8 verification"
          
      - name: Setup Java 11
        uses: actions/setup-java@sdkman-integration
        with:
          distribution: 'corretto'
          java-version-file: 'test-11.0.29-amzn/.sdkmanrc'
          
      - name: Verify Java 11
        run: |
          java -version 2>&1 | grep "11" || echo "Java 11 verification"
          
      - name: Setup Java 17
        uses: actions/setup-java@sdkman-integration
        with:
          distribution: 'corretto'
          java-version-file: 'test-17.0.17-amzn/.sdkmanrc'
          
      - name: Verify Java 17
        run: |
          java -version 2>&1 | grep "17" || echo "Java 17 verification"
          
      - name: Setup Java 21
        uses: actions/setup-java@sdkman-integration
        with:
          distribution: 'corretto'
          java-version-file: 'test-21.0.9-amzn/.sdkmanrc'
          
      - name: Verify Java 21
        run: |
          java -version 2>&1 | grep "21" || echo "Java 21 verification"
